name: Build Qt6 for macOS ARM64 and Commit to Repo

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  # push:
  #   branches: [ main ]

permissions:
  contents: write  # å…è®¸æŽ¨é€ä»£ç 

jobs:
  build-qt6-mac-arm:
    runs-on: macos-14-arm64  # Apple Silicon runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²ä»¥ä¾¿æŽ¨é€

      - name: Install dependencies
        run: |
          brew install \
            ninja \
            pkg-config \
            openssl@3 \
            sqlite \
            pcre2 \
            double-conversion \
            libpng \
            freetype

      - name: Set environment variables
        run: |
          echo "QT_VERSION=6.7.0" >> $GITHUB_ENV
          echo "QT_INSTALL_DIR=${PWD}/qt6-install" >> $GITHUB_ENV
          echo "BUILD_DIR=${PWD}/qt6-build" >> $GITHUB_ENV
          echo "SRC_DIR=${PWD}/qt6-src" >> $GITHUB_ENV

      - name: Clone Qt6 source (shallow)
        run: |
          git clone --depth=1 --branch v${{ env.QT_VERSION }} \
            https://code.qt.io/qt/qt5.git ${{ env.SRC_DIR }}
          cd ${{ env.SRC_DIR }}
          perl init-repository --module-subset=qtbase

      - name: Configure Qt6 (minimal for qBittorrent)
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          cd ${{ env.BUILD_DIR }}

          ${{ env.SRC_DIR }}/configure \
            -prefix ${{ env.QT_INSTALL_DIR }} \
            -release \
            -opensource \
            -confirm-license \
            -static \
            -no-opengl \
            -no-feature-gui \
            -no-feature-widgets \
            -no-feature-sql \
            -no-feature-testlib \
            -feature-network \
            -feature-concurrent \
            -ssl \
            -system-freetype \
            -system-sqlite \
            -make libs \
            -nomake examples \
            -nomake tests \
            -skip qt3d \
            -skip qt5compat \
            -skip qtactiveqt \
            -skip qtdeclarative \
            -skip qtwebengine \
            -verbose \
            -platform macx-xcode

      - name: Build Qt6
        run: |
          cd ${{ env.BUILD_DIR }}
          cmake --build . -j$(sysctl -n hw.ncpu)

      - name: Install Qt6 to local dir
        run: |
          cd ${{ env.BUILD_DIR }}
          cmake --install .

      - name: Package Qt6
        run: |
          cd ${{ env.QT_INSTALL_DIR }}
          tar -czf qt6-mac-arm64-${{ env.QT_VERSION }}.tar.gz .

      - name: Prepare repo directory
        run: |
          mkdir -p prebuilt/qt6-mac-arm64
          cp ${{ env.QT_INSTALL_DIR }}/qt6-mac-arm64-${{ env.QT_VERSION }}.tar.gz prebuilt/qt6-mac-arm64/

      - name: Commit and push built Qt6
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add prebuilt/qt6-mac-arm64/
          git status

          if ! git diff --cached --quiet; then
            git commit -m "ðŸ“¦ Add prebuilt Qt6 ${{ env.QT_VERSION }} for macOS ARM64"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi
