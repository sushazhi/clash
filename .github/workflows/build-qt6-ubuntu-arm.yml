name: Build Qt6 for Ubuntu ARM64 and Commit to Repo

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
  # push:
  #   branches: [ main ]  # å¦‚éœ€è‡ªåŠ¨è§¦å‘ï¼Œå–æ¶ˆæ³¨é‡Š

permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 

jobs:
  build-qt6-ubuntu-arm:
    runs-on: ubuntu-22.04  # x86_64 runner + QEMU æ¨¡æ‹Ÿ ARM64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥ä¾¿æ¨é€

      - name: Set up QEMU and run on aarch64 (Ubuntu 22.04)
        uses: uraimo/run-on-arch-action@v2.7.0
        with:
          arch: aarch64
          distro: ubuntu22.04
          # âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨å®˜æ–¹å¤šæ¶æ„é•œåƒï¼Œé¿å… arm64v8/ å·²åºŸå¼ƒé—®é¢˜
          baseImage: ubuntu:22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          install: |
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              build-essential \
              cmake \
              ninja-build \
              pkg-config \
              git \
              perl \
              python3 \
              gperf \
              bison \
              flex \
              libgl1-mesa-dev \
              libx11-dev \
              libxcb-xinerama0-dev \
              libfontconfig1-dev \
              libfreetype6-dev \
              libssl-dev \
              libglib2.0-dev \
              libsqlite3-dev \
              libicu-dev \
              wget \
              tar \
              xz-utils \
              ca-certificates \
              curl
          run: |
            echo "=== Building Qt6 for Ubuntu ARM64 (aarch64) ==="

            QT_VERSION=6.7.0
            SRC_DIR=qt6-src
            BUILD_DIR=qt6-build
            INSTALL_DIR=/opt/qt6-arm

            # Clone Qt6 source (qt5.git repo contains Qt6 since 6.0)
            git clone --depth=1 --branch v${QT_VERSION} https://code.qt.io/qt/qt5.git ${SRC_DIR}
            cd ${SRC_DIR}
            perl init-repository --module-subset=qtbase

            # Create build directory
            mkdir -p ../${BUILD_DIR}
            cd ../${BUILD_DIR}

            # Configure Qt6 (minimal for qBittorrent 5.1.4)
            ../${SRC_DIR}/configure \
              -prefix ${INSTALL_DIR} \
              -release \
              -opensource \
              -confirm-license \
              -static \
              -no-opengl \
              -no-feature-gui \
              -no-feature-widgets \
              -no-feature-sql \
              -no-feature-testlib \
              -feature-network \
              -feature-concurrent \
              -ssl \
              -system-freetype \
              -system-sqlite \
              -make libs \
              -nomake examples \
              -nomake tests \
              -skip qt3d \
              -skip qt5compat \
              -skip qtdeclarative \
              -skip qtwebengine \
              -verbose

            # Build and install
            cmake --build . -j$(nproc)
            cmake --install .

            # Package into tar.gz
            cd ${INSTALL_DIR}
            tar -czf qt6-ubuntu-arm64-${QT_VERSION}.tar.gz .

            # Copy to /workspace so outer step can access it
            mkdir -p /workspace/prebuilt/qt6-ubuntu-arm64
            cp qt6-ubuntu-arm64-${QT_VERSION}.tar.gz /workspace/prebuilt/qt6-ubuntu-arm64/

      - name: Push built Qt6 to repository
        run: |
          # Navigate to main workspace
          cd "$GITHUB_WORKSPACE"

          # Copy artifact from QEMU container output
          mkdir -p prebuilt/qt6-ubuntu-arm64
          cp /tmp/run-on-arch/workspace/prebuilt/qt6-ubuntu-arm64/*.tar.gz prebuilt/qt6-ubuntu-arm64/ || {
            echo "âŒ No Qt6 artifact found!"
            exit 1
          }

          # Git config
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add, commit, and push
          git add prebuilt/qt6-ubuntu-arm64/
          if ! git diff-index --quiet HEAD; then
            git commit -m "ğŸ“¦ Add prebuilt Qt6 ${QT_VERSION} for Ubuntu ARM64"
            git push origin "${GITHUB_REF##*/}"
          else
            echo "âœ… No changes â€” Qt6 already up to date."
          fi
